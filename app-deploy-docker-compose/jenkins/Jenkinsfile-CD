pipeline {
    agent any
    environment {
        AWS_ACCOUNT_ID=sh(script: 'export PATH="$PATH:/usr/local/bin" && aws sts get-caller-identity --query Account --output text', returnStdout: true).trim()
    }

    stages {
        stage('ENVSUBST UPDATE DOCKER COMPOSE') {
            steps {
                echo 'env update'
                sh """
                cd app-deploy-docker-compose/docker
                envsubst < docker-compose-template.yml > docker-compose.yml
                """
            }
        }
       stage('Deploy Application') {
            steps {
                echo 'Deploy Application'
                sh 'ls -l'
                sh 'ansible --version'
                sh 'ansible-inventory -i ./app-deploy-docker-compose/ansible/inventory_aws_ec2.yml --graph'
                sh """
                    cd app-deploy-docker-compose/ansible
                    ansible-playbook -i inventory_aws_ec2.yml --private-key=/var/lib/jenkins/workspace/dev -e "compose_dir=${WORKSPACE}/app-deploy-docker-compose/docker" dev.yml -vv
                """
             }
        }
         
    }
    
    post {
        always {
            echo 'CD Pipeline completed'
        }
          success {
            echo 'CD Pipeline completed successfully'
          }
         
        failure {
            echo 'CD Pipeline failed'
            }
        }
}
