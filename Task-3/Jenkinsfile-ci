pipeline {
  agent any

  environment {
    AWS_REGION = 'eu-central-1'
  }

  stages {
    stage('Set AWS Account ID and TAG') {
      steps {
        script {
          env.AWS_ACCOUNT_ID = sh(script: "aws sts get-caller-identity --query 'Account' --output text", returnStdout: true).trim()
          env.GIT_TAG = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
          env.FRONTEND_IMAGE = "${env.AWS_ACCOUNT_ID}.dkr.ecr.${env.AWS_REGION}.amazonaws.com/frontend-repo"
          env.BACKEND_IMAGE  = "${env.AWS_ACCOUNT_ID}.dkr.ecr.${env.AWS_REGION}.amazonaws.com/backend-repo"
        }
      }
    }

    stage('Clone Repo') {
      steps {
        git credentialsId: 'github-token-erkan', url: 'https://github.com/techpro-aws-devops/RealEstateAppProject.git', branch: 'main'
      }
    }

    stage('ECR Login') {
      steps {
        sh '''
          aws ecr get-login-password --region $AWS_REGION | \
          docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
        '''
      }
    }

    stage('Build & Push Frontend') {
      steps {
        sh '''
          docker build -t $FRONTEND_IMAGE:$GIT_TAG ./True-Roots-Frontend
          docker tag $FRONTEND_IMAGE:$GIT_TAG $FRONTEND_IMAGE:latest
          docker push $FRONTEND_IMAGE:$GIT_TAG
          docker push $FRONTEND_IMAGE:latest
        '''
      }
    }

    stage('Build & Push Backend') {
      steps {
        sh '''
          docker build -t $BACKEND_IMAGE:$GIT_TAG ./True-Roots-Backend
          docker tag $BACKEND_IMAGE:$GIT_TAG $BACKEND_IMAGE:latest
          docker push $BACKEND_IMAGE:$GIT_TAG
          docker push $BACKEND_IMAGE:latest
        '''
      }
    }
  }
}
